From 9177cce4cc7a8da5a524d5add1e055a6b9d863c2 Mon Sep 17 00:00:00 2001
From: Daniel Kolesa <daniel@octaforge.org>
Date: Wed, 6 Apr 2022 00:59:22 +0200
Subject: [PATCH 11/22] HACK: always disable LTO for libunwind, libc++,
 libc++abi

---
 libcxx/CMakeLists.txt        | 3 +++
 libcxxabi/CMakeLists.txt     | 3 +++
 libunwind/src/CMakeLists.txt | 3 +++
 3 files changed, 9 insertions(+)

diff --git a/libcxx/CMakeLists.txt b/libcxx/CMakeLists.txt
index 19f423bf0..cfb5b4480 100644
--- a/libcxx/CMakeLists.txt
+++ b/libcxx/CMakeLists.txt
@@ -841,6 +841,9 @@ function(cxx_link_system_libraries target)
   if (ANDROID AND ANDROID_PLATFORM_LEVEL LESS 21)
     target_link_libraries(${target} PUBLIC android_support)
   endif()
+
+  target_add_compile_flags_if_supported(${target} PRIVATE "-fno-lto")
+  target_add_link_flags_if_supported(${target} PRIVATE "-fno-lto")
 endfunction()
 
 # Windows-related flags =======================================================
diff --git a/libcxxabi/CMakeLists.txt b/libcxxabi/CMakeLists.txt
index 94e625f44..dc8ae6760 100644
--- a/libcxxabi/CMakeLists.txt
+++ b/libcxxabi/CMakeLists.txt
@@ -383,6 +383,9 @@ else()
   add_compile_flags_if_supported(-EHa-)
 endif()
 
+add_compile_flags("-fno-lto")
+add_link_flags("-fno-lto")
+
 # Assert
 string(TOUPPER "${CMAKE_BUILD_TYPE}" uppercase_CMAKE_BUILD_TYPE)
 if (LIBCXXABI_ENABLE_ASSERTIONS)
diff --git a/libunwind/src/CMakeLists.txt b/libunwind/src/CMakeLists.txt
index 710198550..e610abf84 100644
--- a/libunwind/src/CMakeLists.txt
+++ b/libunwind/src/CMakeLists.txt
@@ -111,6 +111,9 @@ if (APPLE)
   endif ()
 endif ()
 
+add_compile_flags("-fno-lto")
+add_link_flags("-fno-lto")
+
 string(REPLACE ";" " " LIBUNWIND_COMPILE_FLAGS "${LIBUNWIND_COMPILE_FLAGS}")
 string(REPLACE ";" " " LIBUNWIND_CXX_FLAGS "${LIBUNWIND_CXX_FLAGS}")
 string(REPLACE ";" " " LIBUNWIND_C_FLAGS "${LIBUNWIND_C_FLAGS}")
-- 
2.35.1

