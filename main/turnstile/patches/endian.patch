From b68c8afd651158112b9af720954ef1aef71b9ba6 Mon Sep 17 00:00:00 2001
From: q66 <q66@chimera-linux.org>
Date: Tue, 20 Jun 2023 04:49:46 +0200
Subject: [PATCH] fix endian encoding for protocol

---
 meson.build          | 2 ++
 src/pam_turnstile.cc | 6 +++---
 src/turnstiled.cc    | 4 +++-
 3 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/meson.build b/meson.build
index d07065e..bb37fd3 100644
--- a/meson.build
+++ b/meson.build
@@ -49,6 +49,8 @@ configure_file(output: 'config.hh', configuration: conf_data)
 
 extra_inc = [include_directories('src')]
 
+add_project_arguments('-D_BSD_SOURCE', language: 'cpp')
+
 daemon_sources = [
     'src/turnstiled.cc',
     'src/fs_utils.cc',
diff --git a/src/pam_turnstile.cc b/src/pam_turnstile.cc
index 26b88ff..c3695ae 100644
--- a/src/pam_turnstile.cc
+++ b/src/pam_turnstile.cc
@@ -17,6 +17,7 @@
 #include <algorithm>
 
 #include <pwd.h>
+#include <endian.h>
 #include <unistd.h>
 #include <syslog.h>
 #include <sys/stat.h>
@@ -128,9 +129,7 @@ static bool open_session(
             unsigned int pkt = 0;
             auto psize = MSG_SBYTES(slen);
             std::memcpy(&pkt, sdir, psize);
-            pkt <<= MSG_TYPE_BITS;
-            pkt |= MSG_DATA;
-            if (!send_msg(pkt)) {
+            if (!send_msg(MSG_DATA | (le32toh(pkt) << MSG_TYPE_BITS))) {
                 return false;
             }
             sdir += psize;
@@ -236,6 +235,7 @@ static bool open_session(
                     }
                     /* we are receiving the string... */
                     int pkts = MSG_SBYTES(rlen);
+                    msg = htole32(msg);
                     std::memcpy(rbuf, &msg, pkts);
                     rbuf += pkts;
                     rlen -= pkts;
diff --git a/src/turnstiled.cc b/src/turnstiled.cc
index 50b31f4..d8430a9 100644
--- a/src/turnstiled.cc
+++ b/src/turnstiled.cc
@@ -22,6 +22,7 @@
 #include <pwd.h>
 #include <poll.h>
 #include <fcntl.h>
+#include <endian.h>
 #include <unistd.h>
 #include <sys/stat.h>
 #include <sys/wait.h>
@@ -271,6 +272,7 @@ static bool handle_session_new(
     }
     if (it.dirleft) {
         auto pkt = MSG_SBYTES(it.dirleft);
+        msg = htole32(msg);
         std::memcpy(&it.homedir[it.dirgot], &msg, pkt);
         it.dirgot += pkt;
         it.dirleft -= pkt;
@@ -423,7 +425,7 @@ static bool handle_read(int fd) {
             }
             auto *rstr = sess->rundir;
             std::memcpy(&v, rstr + rlen - msg, MSG_SBYTES(msg));
-            return msg_send(fd, MSG_ENCODE(v));
+            return msg_send(fd, MSG_ENCODE(le32toh(v)));
         }
         case MSG_DATA: {
             msg >>= MSG_TYPE_BITS;
-- 
2.41.0
