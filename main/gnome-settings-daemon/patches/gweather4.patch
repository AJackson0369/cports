From 7f9a55513fe60b31bef114fff088e36f84c861b4 Mon Sep 17 00:00:00 2001
From: Emmanuele Bassi <ebassi@gnome.org>
Date: Fri, 31 Dec 2021 17:02:21 +0000
Subject: [PATCH 1/4] Port to GWeather 4

Use the new GWeather major version.

The only change consists in replacing GWeatherTimezone with GTimeZone.
---
 meson.build                   | 2 +-
 plugins/datetime/weather-tz.c | 5 +++--
 2 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/meson.build b/meson.build
index 58b622ac..85f767f0 100644
--- a/meson.build
+++ b/meson.build
@@ -96,7 +96,7 @@ gnome_desktop_dep = dependency('gnome-desktop-3.0', version: '>= 3.37.1')
 gsettings_desktop_dep = dependency('gsettings-desktop-schemas', version: '>= 42')
 gtk_dep = dependency('gtk+-3.0', version: '>= 3.15.3')
 gtk_x11_dep = dependency('gtk+-x11-3.0')
-gweather_dep = dependency('gweather-3.0', version: '>= 40.alpha')
+gweather_dep = dependency('gweather4')
 lcms_dep = dependency('lcms2', version: '>= 2.2')
 libcanberra_gtk_dep = dependency('libcanberra-gtk3')
 libgeoclue_dep = dependency('libgeoclue-2.0', version: '>= 2.3.1')
diff --git a/plugins/datetime/weather-tz.c b/plugins/datetime/weather-tz.c
index 2eac90a2..b76a2b8c 100644
--- a/plugins/datetime/weather-tz.c
+++ b/plugins/datetime/weather-tz.c
@@ -22,7 +22,6 @@
 #include "weather-tz.h"
 #include "tz.h"
 
-#define GWEATHER_I_KNOW_THIS_IS_UNSTABLE
 #include <libgweather/gweather.h>
 
 static GList *
@@ -65,6 +64,7 @@ load_timezones (GList *cities)
                 TzLocation *loc;
                 const gchar *country;
                 const gchar *timezone_id;
+                GTimeZone *tz;
                 gdouble latitude;
                 gdouble longitude;
 
@@ -77,7 +77,8 @@ load_timezones (GList *cities)
                 }
 
                 country = gweather_location_get_country (l->data);
-                timezone_id = gweather_timezone_get_tzid (gweather_location_get_timezone (l->data));
+                tz = gweather_location_get_timezone (l->data);
+                timezone_id = g_time_zone_get_identifier (tz);
                 gweather_location_get_coords (l->data,
                                               &latitude,
                                               &longitude);
-- 
GitLab


From 3ef57cd9fb36caa2253b83348032fe78700981b4 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Javier=20Jard=C3=B3n?= <jjardon@gnome.org>
Date: Tue, 4 Jan 2022 00:50:17 +0000
Subject: [PATCH 2/4] plugins/datetime/weather-tz.c: Use g_object_ref() instead
 gweather_location_ref()

---
 plugins/datetime/weather-tz.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/plugins/datetime/weather-tz.c b/plugins/datetime/weather-tz.c
index b76a2b8c..f2d38d96 100644
--- a/plugins/datetime/weather-tz.c
+++ b/plugins/datetime/weather-tz.c
@@ -32,7 +32,7 @@ location_get_cities (GWeatherLocation *parent_location)
 
         while ((child = gweather_location_next_child (parent_location, child))) {
                 if (gweather_location_get_level (child) == GWEATHER_LOCATION_CITY) {
-                        cities = g_list_prepend (cities, gweather_location_ref (child));
+                        cities = g_list_prepend (cities, g_object_ref (child));
                 } else {
                         cities = g_list_concat (cities,
                                                 location_get_cities (child));
-- 
GitLab


From 4a683bb7f4568ee17d88f9ac9ea7f2cda0d00522 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Javier=20Jard=C3=B3n?= <jjardon@gnome.org>
Date: Thu, 20 Jan 2022 14:11:46 +0000
Subject: [PATCH 3/4] .gitlab-ci.yml: Try to use fedora 36

---
 .gitlab-ci.yml | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/.gitlab-ci.yml b/.gitlab-ci.yml
index f7deb597..f176dd3b 100644
--- a/.gitlab-ci.yml
+++ b/.gitlab-ci.yml
@@ -1,9 +1,9 @@
 include:
- - remote: 'https://gitlab.freedesktop.org/freedesktop/ci-templates/-/raw/5888c7388134cbe4661600222fe9befb10441f6e/templates/fedora.yml'
+ - remote: 'https://gitlab.freedesktop.org/freedesktop/ci-templates/-/raw/80f87b3058efb75a1faae11826211375fba77e7f/templates/fedora.yml'
 
 variables:
   FDO_DISTRIBUTION_TAG: latest
-  FDO_DISTRIBUTION_VERSION: rawhide
+  FDO_DISTRIBUTION_VERSION: 36
   FDO_UPSTREAM_REPO: gnome/gnome-settings-daemon
   # Expiry sets fdo.expires on the image
   FEDORA_IMAGE: "$CI_REGISTRY/$FDO_UPSTREAM_REPO/fedora/$FDO_DISTRIBUTION_VERSION:$FDO_DISTRIBUTION_TAG"
-- 
GitLab


From 5cfdc3f68b5a27a61f0f5680fa06679df06c80b2 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Javier=20Jard=C3=B3n?= <jjardon@gnome.org>
Date: Thu, 20 Jan 2022 13:42:11 +0000
Subject: [PATCH 4/4] .gitlab-ci.yml: Install libgweather4

---
 .gitlab-ci.yml | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/.gitlab-ci.yml b/.gitlab-ci.yml
index f176dd3b..75836132 100644
--- a/.gitlab-ci.yml
+++ b/.gitlab-ci.yml
@@ -31,7 +31,7 @@ variables:
     libcanberra-devel
     libgtop2-devel
     libgudev-devel
-    libgweather-devel
+    libgweather4-devel
     libnotify-devel
     librsvg2-devel
     libwacom-devel
-- 
GitLab

